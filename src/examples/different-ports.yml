description: >
  Connect to multiple clusters on different ports
usage:
  version: 2.1
  orbs:
    k3d: devopsspiral/k3d@0.1.3
  jobs:
    test-different-ports:
      #can be any docker executor
      executor: k3d/default
      steps:
        - setup_remote_docker
        - checkout
        - k3d/k3d-helpers
        - k3d/k3d-up:
            cluster-name: circleci-k8s-2
            k3s-version: v1.16.14-k3s1
            api-port: 6444
        - k3d/k3d-up:
            cluster-name: circleci-k8s-1
        - k3d/k3d-run:
            step-name: Connect to multiple clusters on different ports
            command: |
              # Connect to two docker networks
              docker create --rm --name kubectl \
              --network container:k3d-circleci-k8s-1-serverlb \
              --entrypoint /bin/sh \
              --volumes-from kubeconfig bitnami/kubectl bash -c 'KUBECONFIG=/.kube/circleci-k8s-1 kubectl version; KUBECONFIG=/.kube/circleci-k8s-2 kubectl version '
              docker network connect container:k3d-circleci-k8s-2-serverlb kubectl
              docker start -a kubectl
  workflows:
    main:
      jobs:
        - test-different-ports
